{% extends "base.html" %}
{% block title %}Panel de Administraci√≥n ‚Äî Full Finanzas{% endblock %}
{% block meta_description %}Control de KYC, dep√≥sitos, retiros y movimientos del exchange.{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-8">

  <!-- Header + b√∫squeda global -->
  <header class="mb-6 flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
    <div>
      <h1 class="text-2xl sm:text-3xl font-extrabold">Panel de Administraci√≥n</h1>
      <p class="text-white/70">Gestion√° verificaci√≥n, dep√≥sitos, retiros y movimientos.</p>
    </div>
    <form method="get" action="" class="w-full md:w-auto">
      <div class="flex gap-2">
        <input name="q" value="{{ request.GET.q }}" placeholder="Buscar usuario, email, DNI, c√≥digo‚Ä¶"
               class="w-full md:w-80 rounded-lg border border-white/10 bg-white text-black px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neon"/>
        <button class="rounded-lg bg-neon text-black font-semibold px-4 py-2">Buscar</button>
      </div>
    </form>
  </header>

  <!-- KPIs -->
  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-8">
    <div class="card p-4 shadow-soft">
      <p class="text-white/60 text-sm">Usuarios pendientes KYC</p>
      <p class="text-2xl font-bold">{{ kpi_pendientes_kyc|default:"0" }}</p>
    </div>
    <div class="card p-4 shadow-soft">
      <p class="text-white/60 text-sm">Dep√≥sitos pendientes</p>
      <p class="text-2xl font-bold">{{ kpi_depositos_pend|default:"0" }}</p>
    </div>
    <div class="card p-4 shadow-soft">
      <p class="text-white/60 text-sm">Retiros ARS pendientes</p>
      <p class="text-2xl font-bold">{{ kpi_retiros_ars_pend|default:"0" }}</p>
    </div>
    <div class="card p-4 shadow-soft">
      <p class="text-white/60 text-sm">Retiros CRYPTO pendientes</p>
      <p class="text-2xl font-bold">{{ kpi_retiros_crypto_pend|default:"0" }}</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mb-6 flex flex-wrap gap-2">
    <a href="#kyc" class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="kyc">KYC</a>
    <a href="#retiros" class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="retiros">Retiros ARS</a>
    <a href="#retiros-crypto" class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="retiros-crypto">Retiros CRYPTO</a>
    <a href="#depositos" class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="depositos">Dep√≥sitos</a>
    <a href="#movs" class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="movs">Movimientos</a>
    <a href="#export" class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="export">Exportar</a>
  </div>

  <!-- KYC -->
  <section id="panel-kyc" data-panel="kyc" class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Usuarios con verificaci√≥n pendiente</h2>
      <p class="text-sm text-white/60">Hac√© click en el usuario para abrir su perfil.</p>
    </div>

    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-white/80">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Email</th>
            <th class="px-3 py-2 text-left">DNI frente</th>
            <th class="px-3 py-2 text-left">DNI dorso</th>
            <th class="px-3 py-2 text-left">Estado</th>
            <th class="px-3 py-2 text-left">Acciones</th>
            <th class="px-3 py-2 text-left">Historial</th>
          </tr>
        </thead>
        <tbody>
          {% for u in usuarios %}
            {% if u.estado_verificacion != 'aprobado' %}
            <tr class="hover:bg-white/5">
              <td class="px-3 py-2">
                <a class="text-neon hover:underline" href="{% url 'admin_usuario_perfil' u.id %}">{{ u.username }}</a>
              </td>
              <td class="px-3 py-2">{{ u.email }}</td>
              <td class="px-3 py-2">
                {% if u.dni_frente %}
                  <button type="button" class="thumb-btn underline text-white/80 hover:text-neon"
                          data-img="{{ u.dni_frente.url }}">Ver</button>
                {% else %}<span class="text-white/40">‚Äî</span>{% endif %}
              </td>
              <td class="px-3 py-2">
                {% if u.dni_dorso %}
                  <button type="button" class="thumb-btn underline text-white/80 hover:text-neon"
                          data-img="{{ u.dni_dorso.url }}">Ver</button>
                {% else %}<span class="text-white/40">‚Äî</span>{% endif %}
              </td>
              <td class="px-3 py-2 capitalize">{{ u.estado_verificacion }}</td>
              <td class="px-3 py-2">
                <form method="post" action="{% url 'cambiar_estado_verificacion' u.id %}" class="flex items-center gap-2">
                  {% csrf_token %}
                  <select name="estado"
                          class="rounded-md border border-white/10 bg-white text-black px-2 py-1 focus:outline-none focus:ring-2 focus:ring-neon">
                    <option value="pendiente" {% if u.estado_verificacion == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="aprobado" {% if u.estado_verificacion == 'aprobado' %}selected{% endif %}>Aprobado</option>
                    <option value="rechazado" {% if u.estado_verificacion == 'rechazado' %}selected{% endif %}>Rechazado</option>
                  </select>
                  <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Actualizar</button>
                </form>
              </td>
              <td class="px-3 py-2">
                <a class="rounded-md border border-white/10 px-3 py-1 hover:bg-white/5"
                   href="{% url 'historial_usuario' u.id %}">Ver historial</a>
              </td>
            </tr>
            {% endif %}
          {% empty %}
            <tr><td colspan="7" class="px-3 py-4 text-white/60 text-center">Sin pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Retiros ARS -->
  <section id="panel-retiros" data-panel="retiros" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">Retiros pendientes (ARS)</h2>
    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-white/80">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Monto</th>
            <th class="px-3 py-2 text-left">Alias</th>
            <th class="px-3 py-2 text-left">CBU</th>
            <th class="px-3 py-2 text-left">Banco</th>
            <th class="px-3 py-2 text-left">Estado</th>
            <th class="px-3 py-2 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for r in retiros %}
            {% if r.estado != 'enviado' %}
            <tr class="hover:bg-white/5">
              <td class="px-3 py-2"><a class="text-neon hover:underline" href="{% url 'admin_usuario_perfil' r.usuario.id %}">{{ r.usuario.username }}</a></td>
              <td class="px-3 py-2">${{ r.monto }}</td>
              <td class="px-3 py-2">{{ r.alias }}</td>
              <td class="px-3 py-2">{{ r.cbu }}</td>
              <td class="px-3 py-2">{{ r.banco }}</td>
              <td class="px-3 py-2 capitalize">{{ r.estado }}</td>
              <td class="px-3 py-2">
                <div class="flex gap-2">
                  {% if r.estado == 'pendiente' %}
                  <form method="post" action="{% url 'aprobar_retiro' r.id %}">{% csrf_token %}
                    <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Aprobar</button>
                  </form>
                  <form method="post" action="{% url 'rechazar_retiro' r.id %}">{% csrf_token %}
                    <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Aprobar</button>
                  </form>
                  {% endif %}
                  {% if r.estado == 'aprobado' %}
                  <form method="post" action="{% url 'enviar_retiro' r.id %}">{% csrf_token %}
                    <button class="rounded-md border border-white/10 px-3 py-1 hover:bg-white/5">Marcar enviado</button>
                  </form>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endif %}
          {% empty %}
            <tr><td colspan="7" class="px-3 py-4 text-white/60 text-center">Sin retiros pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Retiros CRYPTO -->
  <section id="panel-retiros-crypto" data-panel="retiros-crypto" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">Retiros CRYPTO</h2>
    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-white/80">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Moneda</th>
            <th class="px-3 py-2 text-left">Monto</th>
            <th class="px-3 py-2 text-left">Wallet</th>
            <th class="px-3 py-2 text-left">Estado</th>
            <th class="px-3 py-2 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for retiro in retiros_crypto %}
          <tr class="hover:bg-white/5">
            <td class="px-3 py-2"><a class="text-neon hover:underline" href="{% url 'admin_usuario_perfil' retiro.usuario.id %}">{{ retiro.usuario.username }}</a></td>
            <td class="px-3 py-2">{{ retiro.moneda }}</td>
            <td class="px-3 py-2">{{ retiro.monto }}</td>
            <td class="px-3 py-2 break-all">{{ retiro.direccion_wallet }}</td>
            <td class="px-3 py-2 capitalize">{{ retiro.estado }}</td>
            <td class="px-3 py-2">
              {% if retiro.estado == 'pendiente' %}
              <form method="post" action="{% url 'aprobar_retiro_cripto' retiro.id %}">
                {% csrf_token %}
                <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Aprobar</button>
              </form>
              <form method="post" action="{% url 'rechazar_retiro_cripto' retiro.id %}">
                {% csrf_token %}
                <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Rechazar</button>
              </form>
              {% else %}
              <span class="text-white/60">‚Äî</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="px-3 py-4 text-white/60 text-center">No hay retiros CRYPTO pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Dep√≥sitos -->
  <section id="panel-depositos" data-panel="depositos" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">Dep√≥sitos pendientes</h2>
    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-white/80">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Monto</th>
            <th class="px-3 py-2 text-left">Comprobante</th>
            <th class="px-3 py-2 text-left">Fecha</th>
            <th class="px-3 py-2 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for d in depositos %}
            {% if d.estado == 'pendiente' %}
            <tr class="hover:bg-white/5">
              <td class="px-3 py-2"><a class="text-neon hover:underline" href="{% url 'admin_usuario_perfil' d.usuario.id %}">{{ d.usuario.username }}</a></td>
              <td class="px-3 py-2">${{ d.monto }}</td>
              <td class="px-3 py-2">
                {% if d.comprobante %}
                  <button type="button" class="thumb-btn underline text-white/80 hover:text-neon"
                          data-img="{{ d.comprobante.url }}">Ver</button>
                {% else %}<span class="text-white/40">‚Äî</span>{% endif %}
              </td>
              <td class="px-3 py-2">{{ d.fecha_subida }}</td>
              <td class="px-3 py-2">
                <form method="post" action="{% url 'aprobar_deposito' d.id %}">
                  {% csrf_token %}
                  <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Aprobar</button>
                </form>
              </td>
            </tr>
            {% endif %}
          {% empty %}
            <tr><td colspan="5" class="px-3 py-4 text-white/60 text-center">Sin dep√≥sitos pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Exportar -->
  <section id="panel-export" data-panel="export" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">Exportar movimientos</h2>
    <form method="GET" action="{% url 'exportar_movimientos_admin' %}" class="card p-4 grid sm:grid-cols-5 gap-3">
      <label class="block">
        <span class="text-xs text-white/60">Desde</span>
        <input type="date" name="desde" class="w-full rounded-md border border-white/10 bg-white text-black px-3 py-2 focus:ring-2 focus:ring-neon">
      </label>
      <label class="block">
        <span class="text-xs text-white/60">Hasta</span>
        <input type="date" name="hasta" class="w-full rounded-md border border-white/10 bg-white text-black px-3 py-2 focus:ring-2 focus:ring-neon">
      </label>
      <label class="block">
        <span class="text-xs text-white/60">Moneda</span>
        <select name="moneda" class="w-full rounded-md border border-white/10 bg-white text-black px-3 py-2 focus:ring-2 focus:ring-neon">
          <option value="">Todas</option><option>ARS</option><option>USDT</option><option>USD</option>
        </select>
      </label>
      <label class="block">
        <span class="text-xs text-white/60">Tipo</span>
        <select name="tipo" class="w-full rounded-md border border-white/10 bg-white text-black px-3 py-2 focus:ring-2 focus:ring-neon">
          <option value="">Todos</option>
          <option value="deposito">Dep√≥sito</option>
          <option value="retiro">Retiro</option>
          <option value="compra">Compra</option>
          <option value="venta">Venta</option>
          <option value="ajuste">Ajuste</option>
        </select>
      </label>
      <div class="flex items-end">
        <button class="w-full rounded-lg bg-neon text-black font-semibold px-4 py-2">üì• Exportar</button>
      </div>
    </form>
  </section>

  <!-- √öltimos movimientos -->
  <section id="panel-movs" data-panel="movs" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">√öltimos movimientos</h2>
    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-white/80">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Tipo</th>
            <th class="px-3 py-2 text-left">Moneda</th>
            <th class="px-3 py-2 text-left">Monto</th>
            <th class="px-3 py-2 text-left">Descripci√≥n</th>
            <th class="px-3 py-2 text-left">Fecha</th>
            <th class="px-3 py-2 text-left">ID</th>
          </tr>
        </thead>
        <tbody>
          {% for m in movimientos %}
          <tr class="hover:bg-white/5">
            <td class="px-3 py-2"><a class="text-neon hover:underline" href="{% url 'admin_usuario_perfil' m.usuario.id %}">{{ m.usuario.username }}</a></td>
            <td class="px-3 py-2">{{ m.tipo }}</td>
            <td class="px-3 py-2">{{ m.moneda }}</td>
            <td class="px-3 py-2">{{ m.monto }}</td>
            <td class="px-3 py-2">{{ m.descripcion }}</td>
            <td class="px-3 py-2">{{ m.fecha }}</td>
            <td class="px-3 py-2">{{ m.codigo }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="px-3 py-4 text-white/60 text-center">Sin registros recientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</section>

<!-- Lightbox simple para im√°genes + tabs -->
<script>
(function(){
  // Tabs
  const panels = document.querySelectorAll('[data-panel]');
  const btns = document.querySelectorAll('.tab-btn');
  function show(tab){
    panels.forEach(p=>p.classList.toggle('hidden', p.dataset.panel!==tab));
    btns.forEach(b=>{
      const on = b.dataset.tab===tab;
      b.classList.toggle('bg-white/10', on);
      b.classList.toggle('text-white', on);
    });
    history.replaceState(null,'', '#'+tab);
  }
  const initial = (location.hash||'#kyc').replace('#','');
  show(initial);
  btns.forEach(b=>b.addEventListener('click', (e)=>{ e.preventDefault(); show(b.dataset.tab); }));

  // Lightbox b√°sico
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 z-50 hidden items-center justify-center bg-black/70 p-4';
  overlay.innerHTML = `
    <div class="max-w-3xl w-full">
      <div class="relative card p-2">
        <button class="absolute -top-3 -right-3 rounded-full bg-neon text-black font-bold h-8 w-8">√ó</button>
        <img id="lb-img" src="" class="w-full rounded-lg">
      </div>
    </div>`;
  document.body.appendChild(overlay);
  const lbImg = overlay.querySelector('#lb-img');
  const closeBtn = overlay.querySelector('button');
  closeBtn.addEventListener('click', ()=> overlay.classList.add('hidden'));
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) overlay.classList.add('hidden'); });

  document.querySelectorAll('.thumb-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      lbImg.src = b.getAttribute('data-img');
      overlay.classList.remove('hidden');
    });
  });
})();
</script>
{% endblock %}
