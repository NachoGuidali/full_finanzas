{% extends "base.html" %}
{% block title %}Crear cuenta — Full Finanzas{% endblock %}
{% block meta_description %}Registrate para operar USD / USDT cumpliendo requisitos PSAV.{% endblock %}

{% block content %}
<style>
  /* Campos en modo claro dentro del form */
  #formRegistro input[type="text"],
  #formRegistro input[type="email"],
  #formRegistro input[type="password"],
  #formRegistro input[type="tel"],
  #formRegistro input[type="date"],
  #formRegistro input[type="number"],
  #formRegistro input[type="file"],
  #formRegistro select,
  #formRegistro textarea { color:#0a0a0a!important; background:#fff!important; caret-color:#000; }
  #formRegistro input::placeholder, #formRegistro textarea::placeholder { color:#6b7280; opacity:.95; }
  #formRegistro input[readonly], #formRegistro select:disabled, #formRegistro input:disabled, #formRegistro textarea:disabled { background:#f3f4f6!important; color:#111827!important; }
</style>

<section class="max-w-3xl mx-auto px-4 py-8">
  <header class="card p-5 mb-6">
    <h1 class="text-2xl sm:text-3xl font-extrabold">Crear cuenta</h1>
    <p class="text-white/70">Completá tus datos para validar tu identidad.</p>
  </header>

  {% if form.errors %}
  <div class="card p-4 mb-6 border border-red-500/40 bg-red-500/10 text-sm">
    <h4 class="font-semibold mb-1">Revisá estos campos</h4>
    <ul class="list-disc ml-5">
      {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
      {% for field in form %}
        {% if field.errors %}<li><b>{{ field.label }}:</b> {{ field.errors.0 }}</li>{% endif %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% if form.non_field_errors %}
    <div class="card p-4 mb-6 border border-red-500/40 bg-red-500/10 text-sm">
      <h4 class="font-semibold mb-1">No pudimos crear tu cuenta</h4>
      <ul class="list-disc ml-5">
        {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- Stepper -->
  <div class="card p-4 mb-6">
    <ol class="grid grid-cols-4 gap-2 text-sm">
      <li class="step-item" data-step-index="1"><div class="flex items-center gap-2"><span class="step-dot h-6 w-6 rounded-full flex items-center justify-center border border-white/20">1</span><span>Credenciales</span></div></li>
      <li class="step-item" data-step-index="2"><div class="flex items-center gap-2"><span class="step-dot h-6 w-6 rounded-full flex items-center justify-center border border-white/20">2</span><span>Datos personales</span></div></li>
      <li class="step-item" data-step-index="3"><div class="flex items-center gap-2"><span class="step-dot h-6 w-6 rounded-full flex items-center justify-center border border-white/20">3</span><span>Domicilio</span></div></li>
      <li class="step-item" data-step-index="4"><div class="flex items-center gap-2"><span class="step-dot h-6 w-6 rounded-full flex items-center justify-center border border-white/20">4</span><span>KYC</span></div></li>
    </ol>
    <div class="mt-3 h-1 w-full bg-white/10 rounded"><div id="step-progress" class="h-1 bg-neon rounded transition-all" style="width:25%"></div></div>
  </div>

  <!-- FORM -->
  <form method="post" enctype="multipart/form-data" id="formRegistro" class="space-y-6 ">
    {% csrf_token %}

    <!-- Paso 1: Credenciales -->
    <section class="card p-5" data-step="1">
      <h2 class="text-lg font-semibold">Credenciales</h2>
      <div class="mt-4 grid gap-4 sm:grid-cols-2">
        <label class="block">
          <span class="text-xs text-white/60 mb-1 block">Usuario</span>
          {{ form.username }}
          <p class="mt-1 text-xs text-white/60">Solo <b>letras, números y guión bajo</b>; <b>sin espacios</b>. 4–20 caracteres (ej: <code>franco_molina</code>).</p>
          {% if form.username.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.username.errors.0 }}</p>{% endif %}
        </label>

        <label class="block">
          <span class="text-xs text-white/60 mb-1 block">Email</span>
          {{ form.email }}
          <p class="mt-1 text-xs text-white/60">Usá un correo válido al que tengas acceso. Te vamos a enviar verificaciones.</p>
          {% if form.email.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.email.errors.0 }}</p>{% endif %}
        </label>

        <label class="block">
          <span class="text-xs text-white/60 mb-1 block">Contraseña</span>
          {{ form.password1 }}
          <p class="mt-1 text-xs text-white/60">Mínimo <b>8</b> caracteres y debe <b>combinar letras y números</b>. Evitá usar datos obvios.</p>
          {% if form.password1.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.password1.errors.0 }}</p>{% endif %}
        </label>

        <label class="block">
          <span class="text-xs text-white/60 mb-1 block">Confirmar</span>
          {{ form.password2 }}
          <p class="mt-1 text-xs text-white/60">Repetí la misma contraseña.</p>
          {% if form.password2.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.password2.errors.0 }}</p>{% endif %}
        </label>
      </div>
    </section>

    <!-- Paso 2: Datos personales -->
    <section class="card p-5 hidden" data-step="2">
      <h2 class="text-lg font-semibold">Datos personales</h2>
      <div class="mt-4 grid gap-4 sm:grid-cols-2">
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Nombre</span> {{ form.first_name }} {% if form.first_name.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.first_name.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Apellido</span> {{ form.last_name }} {% if form.last_name.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.last_name.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Tipo de persona</span> {{ form.persona_tipo }} {% if form.persona_tipo.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.persona_tipo.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Estado civil</span> {{ form.estado_civil }} {% if form.estado_civil.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.estado_civil.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Sexo</span> {{ form.sexo }} {% if form.sexo.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.sexo.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Nacionalidad</span> {{ form.nacionalidad }} {% if form.nacionalidad.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.nacionalidad.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Fecha de nacimiento</span> {{ form.fecha_nacimiento }} {% if form.fecha_nacimiento.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.fecha_nacimiento.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Lugar de nacimiento</span> {{ form.lugar_nacimiento }} {% if form.lugar_nacimiento.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.lugar_nacimiento.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Tipo de documento</span> {{ form.doc_tipo }} {% if form.doc_tipo.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.doc_tipo.errors.0 }}</p>{% endif %}</label>
        <label class="block">
          <span class="text-xs text-white/60 mb-1 block">N° de documento</span>
          {{ form.doc_nro }}
          <p class="mt-1 text-xs text-white/60">Solo números. DNI/Documento argentino suele tener <b>7 u 8 dígitos</b>.</p>
          {% if form.doc_nro.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.doc_nro.errors.0 }}</p>{% endif %}
        </label>
        <label class="block sm:col-span-2">
          <span class="text-xs text-white/60 mb-1 block">Teléfono</span>
          {{ form.telefono }}
          <p class="mt-1 text-xs text-white/60">Formato: <b>1122334455</b> (10 u 11 dígitos, sin +, 0, espacios ni guiones).</p>
          {% if form.telefono.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.telefono.errors.0 }}</p>{% endif %}
        </label>
      </div>
    </section>

    <!-- Paso 3: Domicilio -->
    <section class="card p-5 hidden" data-step="3">
      <h2 class="text-lg font-semibold">Domicilio</h2>
      <div class="mt-4 grid gap-4 sm:grid-cols-2">
        <label class="block"><span class="text-xs text-white/60 mb-1 block">País</span> {{ form.pais }} {% if form.pais.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.pais.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Provincia</span> {{ form.provincia }} {% if form.provincia.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.provincia.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Localidad</span> {{ form.localidad }} {% if form.localidad.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.localidad.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Código postal</span> {{ form.codigo_postal }} {% if form.codigo_postal.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.codigo_postal.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Calle</span> {{ form.calle }} {% if form.calle.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.calle.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Número</span> {{ form.numero_calle }} {% if form.numero_calle.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.numero_calle.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Piso (opcional)</span> {{ form.piso }} {% if form.piso.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.piso.errors.0 }}</p>{% endif %}</label>
        <label class="block"><span class="text-xs text-white/60 mb-1 block">Depto (opcional)</span> {{ form.depto }} {% if form.depto.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.depto.errors.0 }}</p>{% endif %}</label>
      </div>

      <div class="mt-4">
        <label class="inline-flex items-center gap-2">
          {{ form.acepta_tyc }}
          <span class="text-sm text-white/80">Acepto los <a href="{% url 'tyc' %}" target="_blank" class="text-neon underline">Términos y Condiciones</a>.</span>
        </label>
        {% if form.acepta_tyc.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.acepta_tyc.errors.0 }}</p>{% endif %}
      </div>
    </section>

    <!-- Paso 4: KYC -->
    <section class="card p-5 hidden" data-step="4">
      <h2 class="text-lg font-semibold">Verificación de identidad</h2>
      <p class="text-sm text-white/60">Subí fotos nítidas del documento.</p>
      <div class="mt-4 grid gap-4 sm:grid-cols-2">
        <label class="block">
          <span class="block text-xs text-white/60 mb-1">DNI (frente)</span>
          {{ form.dni_frente }}
          <p class="mt-1 text-xs text-white/60">Formatos: <b>JPG/PNG/WebP</b>. Tamaño máx: <b>5MB</b>.</p>
          {% if form.dni_frente.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.dni_frente.errors.0 }}</p>{% endif %}
        </label>
        <label class="block">
          <span class="block text-xs text-white/60 mb-1">DNI (dorso)</span>
          {{ form.dni_dorso }}
          <p class="mt-1 text-xs text-white/60">Formatos: <b>JPG/PNG/WebP</b>. Tamaño máx: <b>5MB</b>.</p>
          {% if form.dni_dorso.errors %}<p class="mt-1 text-xs text-rose-400">{{ form.dni_dorso.errors.0 }}</p>{% endif %}
        </label>
      </div>
    </section>

    <div class="flex items-center justify-between pt-2">
      <a href="{% url 'login' %}" class="text-sm text-white/70 hover:text-white">¿Ya tenés cuenta? Iniciar sesión</a>
      <div class="flex gap-2">
        <button type="button" id="btnPrev" class="rounded-xl border border-white/10 px-5 py-3 text-sm hover:bg-white/5">Anterior</button>
        <button type="button" id="btnNext" class="rounded-xl bg-neon text-black font-semibold px-5 py-3 text-sm hover:opacity-90">Siguiente</button>
        <button type="submit" id="btnSubmit" class="hidden rounded-xl bg-neon text-black font-semibold px-5 py-3 text-sm hover:opacity-90">Crear cuenta</button>
      </div>
    </div>
  </form>
</section>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const setHidden = (el, b) => el && el.classList.toggle('hidden', b);

  const form = $('#formRegistro');
  let step = 1; const LAST = 4;

  function showStep(n){
    step = Math.min(Math.max(1,n), LAST);
    $$('[data-step]').forEach(sec => setHidden(sec, Number(sec.dataset.step)!==step));
    $$('.step-item').forEach(li=>{
      const idx = Number(li.dataset.stepIndex); const dot = $('.step-dot', li);
      dot.classList.remove('bg-neon','text-black','bg-white/10');
      if (idx < step) { dot.classList.add('bg-neon','text-black'); }
      else if (idx === step) { dot.classList.add('bg-white/10'); }
    });
    $('#step-progress').style.width = (step*25)+'%';
    const prev = $('#btnPrev'), next = $('#btnNext'), submit = $('#btnSubmit');
    if (prev) prev.disabled = (step===1);
    setHidden(next,   step===LAST);
    setHidden(submit, step!==LAST);
  }

  function req(id){ const el=document.getElementById(id); return el && el.value.trim().length>0; }

  // ---- Helpers errores inline (para paso 1) ----
  function clearInlineErrors(container){
    container?.querySelectorAll('[data-inline-error]').forEach(e=>e.remove());
    container?.querySelectorAll('[aria-invalid="true"]').forEach(el=>el.removeAttribute('aria-invalid'));
    container?.querySelectorAll('.ring-red-500').forEach(el=>el.classList.remove('ring-red-500'));
  }
  function showInlineError(input, msg){
    if (!input) return;
    input.setAttribute('aria-invalid','true');
    input.classList.add('ring-red-500');
    const p = document.createElement('p');
    p.className = 'mt-1 text-xs text-rose-400';
    p.setAttribute('data-inline-error','');
    p.textContent = msg;
    input.parentElement.appendChild(p);
  }

  function validateStepClient(s=step){
    if (s===1){
      const u = $('#id_username'), e = $('#id_email'), p1 = $('#id_password1'), p2 = $('#id_password2');
      const cont = document.querySelector('[data-step="1"]');
      clearInlineErrors(cont);
      let ok = true;
      if (!u?.value.trim()) { showInlineError(u, 'Ingresá un usuario.'); ok=false; }
      if (!e?.value.trim()) { showInlineError(e, 'Ingresá un email.'); ok=false; }
      if (!p1?.value.trim()) { showInlineError(p1, 'Ingresá una contraseña.'); ok=false; }
      if (!p2?.value.trim()) { showInlineError(p2, 'Confirmá la contraseña.'); ok=false; }
      if (p1?.value && p1.value.length < 8) { showInlineError(p1, 'La contraseña debe tener al menos 8 caracteres.'); ok=false; }
      if (p1?.value && p2?.value && p1.value !== p2.value){ showInlineError(p2, 'Las contraseñas no coinciden.'); ok=false; }
      return ok;
    }
    if (s===2){
      return ['id_first_name','id_last_name','id_doc_tipo','id_doc_nro','id_telefono'].every(req);
    }
    if (s===3){
      const ok = ['id_pais','id_provincia','id_localidad','id_codigo_postal','id_calle','id_numero_calle'].every(req);
      const tyc = document.getElementById('id_acepta_tyc');
      return ok && (!!tyc && tyc.checked);
    }
    return true;
  }

  function validateAllSteps(){
    for (let s=1; s<=LAST; s++){
      if (!validateStepClient(s)) return { ok:false, firstBad:s };
    }
    return { ok:true, firstBad:null };
  }

  // ---- Navegación ----
  $('#btnNext')?.addEventListener('click', ()=>{ if (!validateStepClient()) return; showStep(step+1); });
  $('#btnPrev')?.addEventListener('click', ()=>showStep(step-1));
  $('#btnSubmit')?.addEventListener('click', (e)=>{
    e.preventDefault();
    const res = validateAllSteps();
    if (!res.ok){
      showStep(res.firstBad);
      const sec = document.querySelector(`[data-step="${res.firstBad}"]`);
      const first = sec?.querySelector('input, select, textarea'); first && first.focus();
      return;
    }
    const selProv = $('#id_provincia'); const selLoc = $('#id_localidad');
    selProv && (selProv.disabled=false); selLoc && (selLoc.disabled=false);
    form.submit();
  });

  // ---- Geo dependientes (ajax) ----
  const selPais = $('#id_pais'), selProv = $('#id_provincia'), selLoc  = $('#id_localidad');
  async function fetchJson(url){ const r=await fetch(url,{headers:{'X-Requested-With':'XMLHttpRequest'}}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  function fillSelect(selectEl, items, getVal='id', getText='nombre', placeholder){
    if (!selectEl) return;
    const current = selectEl.value || '';
    selectEl.innerHTML = '';
    if (placeholder){
      const ph = document.createElement('option'); ph.value=''; ph.textContent=placeholder; ph.disabled=true; ph.selected=!current;
      selectEl.appendChild(ph);
    }
    items.forEach(it=>{ const opt=document.createElement('option'); opt.value=it[getVal]; opt.textContent=it[getText]; selectEl.appendChild(opt); });
    const exists = Array.from(selectEl.options).some(o=>o.value===current);
    if (exists) selectEl.value = current;
    selectEl.disabled = false;
  }
  async function loadProvincias(paisId){
    if (!selProv) return;
    selProv.disabled = true; if (selLoc){ selLoc.disabled = true; selLoc.innerHTML = ''; }
    if (!paisId) { selProv.innerHTML=''; return; }
    try { const data = await fetchJson("{% url 'geo_provincias' %}?pais_id="+encodeURIComponent(paisId));
      fillSelect(selProv, data.provincias||[], 'id','nombre', 'Seleccioná provincia'); selProv.dispatchEvent(new Event('change'));
    } catch(e){ console.error('geo_provincias:', e); }
  }
  async function loadLocalidades(provId){
    if (!selLoc) return; selLoc.disabled = true; if (!provId) { selLoc.innerHTML=''; return; }
    try { const data = await fetchJson("{% url 'geo_localidades' %}?provincia_id="+encodeURIComponent(provId));
      fillSelect(selLoc, data.localidades||[], 'id','nombre', 'Seleccioná localidad');
    } catch(e){ console.error('geo_localidades:', e); }
  }
  selPais?.addEventListener('change', ()=> loadProvincias(selPais.value));
  selProv?.addEventListener('change', ()=> loadLocalidades(selProv.value));
  (function initGeo(){ if (selPais && selPais.value){ loadProvincias(selPais.value); } })();

  // ---- Reglas de entrada (patrones HTML) ----
  (function addInputPatterns(){
    const u = $('#id_username');
    if (u){ u.setAttribute('pattern','^[A-Za-z0-9_]{4,20}$'); u.setAttribute('title','Solo letras, números y _ (4–20).'); u.maxLength = 20; }
    const p1 = $('#id_password1');
    if (p1){ p1.setAttribute('pattern','(?=.*[A-Za-z])(?=.*\\d).{8,}'); p1.setAttribute('title','Mínimo 8, combinar letras y números'); }
    const tel = $('#id_telefono');
    if (tel){ tel.setAttribute('pattern','^\\d{10,11}$'); tel.setAttribute('inputmode','numeric'); tel.setAttribute('title','10 u 11 dígitos, sin + ni espacios (ej: 1122334455)'); }
    const dni = $('#id_doc_nro');
    if (dni){ dni.setAttribute('pattern','^\\d{7,9}$'); dni.setAttribute('inputmode','numeric'); dni.setAttribute('title','Solo números (7–9 dígitos)'); }
    const fr = $('#id_dni_frente'), dr = $('#id_dni_dorso');
    [fr,dr].forEach(f => {
      if (!f) return;
      f.setAttribute('accept','image/jpeg,image/png,image/webp');
    });
  })();

  // ---- Abrir step con error del servidor (si lo hay) ----
  (function jumpToFirstServerError(){
    let target = document.querySelector('[aria-invalid="true"]') || document.querySelector('.text-rose-400');
    if (!target) return;
    const sec = target.closest('[data-step]'); if (!sec) return;
    const n = Number(sec.getAttribute('data-step')); if (n) showStep(n);
    const first = sec.querySelector('input, select, textarea'); first && first.focus();
  })();

  showStep(1);
})();
</script>
{% endblock %}
